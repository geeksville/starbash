# Idea

Would it make sense to add this to Siril?

![Sample session](/doc/img/full_run_results.png)

So I recently did an experiment to see what it would take to use the **spiffy** [VeraLux Hypermetric Stretch](https://github.com/geeksville/siril-scripts/blob/49ad1213d0e13e823e4becd279849690dd48770c/processing/VeraLux_HyperMetric_Stretch.py) directly from starbash (because currently scripts inside of Siril are not structured for automated use).  

This was just a proof of concept but it was surprisingly painless!  After this change Starbash now automatically runs VeraLux stretch on every set of auto generated files it makes while walking through a repo of sessions.  The output files look great and the user doesn't need to do anything (though they can tweak parameters if they wish)!  

One of the things I needed to do was to separate the 'front-end' (graphical UI) of that script from the 'back-end' (engine).  This also allowed me to import the starbash persistent **parameters** definitions into the tool.  As I was doing this I was thinking:

> wow - a lot of script writers end up having to implement a Qt UI, each looking slightly different than the others.  And providing no automated way of connecting scripts with each other. Would moving starbash into the Siril exe help with this?

So I'm making this mini-proposal on moving starbash into Siril as an (optional?) module?  Features it would add to Siril:

* Most script writers wouldn't need to write a UI (though they could if they wanted): Instead, they would define a set of parameters (complete with a user documentation string, and instructions on how they should be rendered in the Siril UI).
* Scripts could specify at what stages in pipelines they want to run (we could extend the stage 'space' over time).
* Because of a clear split between front-end and back-end scripts become more reusable.
* The 'batch processing/session aware' stuff of starbash could allow (with reasonable defaults) easy bulk processing in Siril.  'seestar level easy' but from an open-source project.
* Eventually the .toml file generated for each final 'project' could nicely capture all of the operations performed by the user (for repeatability/replayability).  Though I presume this would need work on (major? - haven't looked yet) enhancements to the undo/redo mechanism to capture all operations in a suitable form. 

Work performed for this experiment:

* I made a stub '[sim siril](https://github.com/geeksville/starbash/blob/main/src/starbash/sim_siril/connection.py)' class that pretends to be Siril for python code that expects to run in that environment.  (Such a class would not be needed if instead Starbash was moved inside of Siril)
* I added a small starbash_main() [entrypoint](https://github.com/geeksville/siril-scripts/blob/49ad1213d0e13e823e4becd279849690dd48770c/processing/VeraLux_HyperMetric_Stretch.py#L1436-L1452), which provides an example of the entrypoint a sirilscript2.0 would provide.  By using a similar naming convention, scripts could be compatible with sirilscript2.0 and sirilscript for quite some time.
* (Not required for the proof-of-concept but possibly useful for info@veralux.space) I added a little function to automate the mapping from FITS camera name metadata to the existing menu he usually offers.
* I added a [.toml](https://github.com/geeksville/siril-scripts/blob/49ad1213d0e13e823e4becd279849690dd48770c/processing/VeraLux_HyperMetric_Stretch.toml) file that tells starbash how to use the attached script.  If a similar approach was used for Siril, siril could especially benefit from concepts like [parameters](https://github.com/geeksville/siril-scripts/blob/49ad1213d0e13e823e4becd279849690dd48770c/processing/VeraLux_HyperMetric_Stretch.toml#L10-L13).  I think by expanding this 'parameter' concept, most siril scripts could require no custom UI code at all.  And the [stage dependency](https://github.com/geeksville/siril-scripts/blob/49ad1213d0e13e823e4becd279849690dd48770c/processing/VeraLux_HyperMetric_Stretch.toml#L27-L29) relationship could be used to automate linking scripts with each other. 

The end result 'just worked' for the usecase in starbash (sample autogenerated job file [attached](/doc/toml/example/processed-repo/example-m81.toml)).  I'm currently unsure if it is worth continuing such an experiment further (adding more 'sim siril' operations inside starbash is not a good long-term solution).  For all previous operations, I've had the tool generate siril scripts then feed them into a series of Siril CLI sessions.

## Questions/next steps?

* Does this sound possibly useful for you?  If so, I'll look around a bit more in the Siril code and extend this proposal with more details.
* Then we can talk again after there is something more specific to discuss.  If everyone thinks this is still looking plausible I'll make a Siril branch and get to work.  
* Then a few experimental releases from that test branch?  If/when it is looking good merge to master?

(If you don't think this is a good match for Siril - no worries.  I just wanted to make this proposal to judge interest.  Thanks for making Siril it rocks! -Kevin)